<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр локаций устройства</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .map-container {
            flex: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #e74c3c;
            color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        .info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
            z-index: 2000;
        }

        /* Стили для кластеров */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }

        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }

        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.6);
        }

        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
        .marker-cluster span {
            line-height: 30px;
        }

        /* Стили для чекбокса */
        .controls {
            margin-top: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            color: white;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            background-color: #34495e;
            border: 2px solid #ecf0f1;
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background-color: #27ae60;
            border-color: #27ae60;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 2px;
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .checkbox-label:hover .checkmark {
            border-color: #3498db;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>Просмотр локаций устройства</h1>
            <p v-if="deviceId">Устройство: {{ deviceId }}</p>
            <div class="controls">
                <label class="checkbox-label">
                    <input type="checkbox" v-model="showRoute" @change="updateMap">
                    <span class="checkmark"></span>
                    Показать линию маршрута
                </label>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div v-if="loading" class="loading">
                <h3>Загрузка данных...</h3>
                <p>Получение локаций для устройства {{ deviceId }}</p>
            </div>

            <div v-if="error" class="error">
                <h3>Ошибка</h3>
                <p>{{ error }}</p>
                <button @click="loadData" style="margin-top: 1rem; padding: 0.5rem 1rem; background: white; color: #e74c3c; border: none; border-radius: 4px; cursor: pointer;">
                    Попробовать снова
                </button>
            </div>

            <div v-if="locations.length > 0" class="info">
                <div><strong>Всего точек:</strong> {{ locations.length }}</div>
                <div v-if="locations.length > 0">
                    <strong>Первая точка:</strong> {{ formatDate(locations[0].timestamp) }}
                </div>
                <div v-if="locations.length > 1">
                    <strong>Последняя точка:</strong> {{ formatDate(locations[locations.length - 1].timestamp) }}
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    deviceId: null,
                    showAll: null,
                    locations: [],
                    loading: false,
                    error: null,
                    map: null,
                    route: null,
                    markerCluster: null,
                    individualMarkers: [],
                    isFirstLoad: true,
                    updateInterval: null,
                    showRoute: false
                }
            },
            mounted() {
                this.getDeviceIdFromUrl();
                this.getShowAllIdFromUrl();
                if (this.deviceId) {
                    this.initMap();
                    this.loadData();
                    // Запускаем автоматическое обновление каждую секунду
                    this.updateInterval = setInterval(() => {
                        this.loadData();
                    }, 1000);
                } else {
                    this.error = 'Не указан параметр deviceId в URL';
                }
            },
            beforeUnmount() {
                // Очищаем интервал при размонтировании компонента
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            },
            methods: {
                getDeviceIdFromUrl() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.deviceId = urlParams.get('deviceId');
                },

                getShowAllIdFromUrl() {
                    const urlParams = new URLSearchParams(window.location.search);
                    this.showAll = urlParams.get('all');
                },

                async loadData() {
                    if (!this.deviceId) return;

                    this.loading = true;
                    this.error = null;

                    try {
                        const response = await fetch(`/view?deviceId=${this.deviceId}&all=${this.showAll}`);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        this.locations = data.locations || [];

                        if (this.locations.length === 0) {
                            this.error = 'Для данного устройства не найдено локаций';
                        } else {
                            this.updateMap();
                        }
                    } catch (err) {
                        this.error = `Ошибка загрузки данных: ${err.message}`;
                    } finally {
                        this.loading = false;
                    }
                },

                initMap() {
                    if (typeof L === 'undefined') {
                        this.error = 'Leaflet не загружен. Проверьте подключение библиотеки.';
                        return;
                    }

                    // Инициализируем карту
                    this.map = L.map('map').setView([55.7558, 37.6176], 10); // Москва по умолчанию

                    // Добавляем слой OpenStreetMap
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);

                    // Инициализируем кластер маркеров
                    this.markerCluster = L.markerClusterGroup({
                        chunkedLoading: true,
                        maxClusterRadius: 50,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: false,
                        zoomToBoundsOnClick: true
                    });
                    this.map.addLayer(this.markerCluster);
                },

                updateMap() {
                    if (!this.map || this.locations.length === 0) return;

                    // Очищаем кластер, отдельные маркеры и маршрут
                    this.markerCluster.clearLayers();
                    this.individualMarkers.forEach(marker => {
                        this.map.removeLayer(marker);
                    });
                    this.individualMarkers = [];
                    if (this.route) {
                        this.map.removeLayer(this.route);
                    }

                    // Создаем массив координат для маршрута
                    const coordinates = this.locations.map(loc => [parseFloat(loc.latitude), parseFloat(loc.longitude)]);

                    // Создаем маршрут (линию) только если showRoute включен
                    if (this.showRoute) {
                        this.route = L.polyline(coordinates, {
                            color: '#FF0000',
                            weight: 3,
                            opacity: 0.8
                        }).addTo(this.map);
                    }

                    // Создаем маркеры для точек
                    this.locations.forEach((location, index) => {
                        const lat = parseFloat(location.latitude);
                        const lng = parseFloat(location.longitude);

                        let markerIcon, popupText;

                        if (index === 0) {
                            // Первая точка - зеленая
                            markerIcon = L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background-color: green; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                                iconSize: [16, 16]
                            });
                            popupText = `Начальная точка<br/>Время: ${this.formatDate(location.timestamp)}`;
                        } else if (index === this.locations.length - 1) {
                            // Последняя точка - красная
                            markerIcon = L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background-color: red; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                                iconSize: [16, 16]
                            });
                            popupText = `Конечная точка<br/>Время: ${this.formatDate(location.timestamp)}`;
                        } else {
                            // Промежуточные точки - синие (показываются только если showRoute включен)
                            if (!this.showRoute) return; // Пропускаем промежуточные точки если маршрут не показан

                            markerIcon = L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background-color: #3498db; width: 8px; height: 8px; border-radius: 50%; border: 2px solid white;"></div>',
                                iconSize: [12, 12]
                            });
                            popupText = `Точка ${index + 1}<br/>Время: ${this.formatDate(location.timestamp)}`;
                        }

                        const marker = L.marker([lat, lng], { icon: markerIcon })
                            .bindPopup(popupText);

                        if (index === this.locations.length - 1) {
                            // Последняя точка добавляется отдельно, не в кластер
                            this.map.addLayer(marker);
                            this.individualMarkers.push(marker);
                        } else if (this.showRoute || index === 0) {
                            // Первая точка и промежуточные (если маршрут показан) добавляются в кластер
                            this.markerCluster.addLayer(marker);
                        }
                    });

                    // Устанавливаем границы карты только при первой загрузке
                    if (this.isFirstLoad) {
                        if (this.route) {
                            // Если маршрут показан, используем его границы
                            this.map.fitBounds(this.route.getBounds(), {
                                padding: [20, 20]
                            });
                        } else if (this.locations.length > 0) {
                            // Если маршрут не показан, используем границы всех точек
                            const bounds = L.latLngBounds(coordinates);
                            this.map.fitBounds(bounds, {
                                padding: [20, 20]
                            });
                        }
                        this.isFirstLoad = false; // Сбрасываем флаг после первой загрузки
                    }
                },

                formatDate(timestamp) {
                    return new Date(parseInt(timestamp, 10)).toLocaleString('ru-RU');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
